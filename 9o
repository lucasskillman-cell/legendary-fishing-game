var fishes = [];
var catchCount = 0;
var gold = 50;
var lastCatchRarity = "None";

function setup() {
  createCanvas(700, 400);
  // Fill array with fish objects
  for (var i = 0; i < 12; i++) {
    fishes.push(new Fish());
  }
  textFont('Helvetica');
}

let lineAndHook = {
  display: function() {
    noFill();  
    strokeWeight(3);
    stroke(0);
    // The hook
    arc(mouseX, mouseY + 95, 30, 60, 0, HALF_PI);
    // The yellow fishing line
    stroke(255, 255, 0);
    line(mouseX, mouseY - 700, mouseX, mouseY + 125);
  }
}

class Fish {
  constructor() {
    this.reset();
  }

  reset() {
    this.x = random(-300, -100);
    this.y = random(150, height - 50);  
    this.xSpeed = random(1, 3);
    this.ySpeed = random(-0.5, 0.5);
    
    // Determine Rarity
    let r = random(100);
    if (r < 1) { this.rarity = "LEGENDARY"; this.col = color(255, 215, 0); this.val = 500; }
    else if (r < 10) { this.rarity = "RARE"; this.col = color(155, 89, 182); this.val = 100; }
    else { this.rarity = "COMMON"; this.col = color(255); this.val = 10; }
    
    this.pileX = -400;
    this.pileY = -400;
  }

  move() {
    this.x += this.xSpeed;
    this.y += this.ySpeed;

    // Boundary bounce
    if (this.y < 140 || this.y > height - 20) {
      this.ySpeed *= -1;
    }
    // Loop across screen
    if (this.x > width + 100) {
      this.reset();
    }  
  }

  display() {
    // Tint fish based on rarity
    tint(this.col);
    image(fishImg, this.x, this.y, 110, 46);
    image(fishImg, this.pileX, this.pileY, 60, 25); // Caught fish in bucket
    noTint();

    // Show "!" when hook is near
    let d = dist(mouseX, mouseY + 125, this.x + 55, this.y + 23);
    if (d < 100 && this.x > 0) {
      fill(this.col);
      textSize(30);
      textStyle(BOLD);
      text("!", this.x + 45, this.y - 10);
      textStyle(NORMAL);
    }
  }  

  addToPile() {
    this.pileX = 610 + random(20);
    this.pileY = 50 + random(30);    
  }
}

function draw() {
  background(123, 215, 132); // Grass
  
  // Draw Water
  noStroke();
  fill(0, 176, 255);
  rect(0, 120, width, height - 120);

  // HUD
  fill(255);
  rect(10, 10, 200, 80, 10);
  fill(0);
  textSize(16);
  text('Total Caught: ' + catchCount, 20, 35);
  text('Gold: ' + gold + 'g', 20, 55);
  textSize(12);
  fill(100);
  text('Last: ' + lastCatchRarity, 20, 75);

  lineAndHook.display();
  
  // Bucket
  image(bucketImg, 600, 40, bucketImg.width / 18, bucketImg.height / 18);
  
  for (let i = 0; i < fishes.length; i++) {
    fishes[i].move();
    fishes[i].display();
    
    // Collision Detection
    if (mouseX > fishes[i].x && mouseX < fishes[i].x + 110 && 
        mouseY + 125 > fishes[i].y && mouseY + 125 < fishes[i].y + 46) {
      
      // Handle Catch
      catchCount++;
      gold += fishes[i].val;
      lastCatchRarity = fishes[i].rarity;
      
      fishes[i].addToPile();
      
      // Delay reset so it stays in bucket
      let f = fishes[i];
      setTimeout(() => { f.reset(); }, 3000);
      
      // Reset position instantly to remove from water
      fishes[i].x = -500; 
    }
  }  
}

function preload() {
  // Use placeholder images if local files aren't found
  fishImg = loadImage('https://upload.wikimedia.org/wikipedia/commons/7/73/Flat_fish_icon.png');
  bucketImg = loadImage('https://cdn-icons-png.flaticon.com/512/305/305981.png');
}
