var fishes = [];
var catchCount = 0;
var gold = 50;
var lastCatchRarity = "None";

// Network & Admin System
var isOnline = true;
var ping = 24;
var serverLuck = 1.0;
var luckTimer = 0;
var adminInput;
var forceMythic = false;
var serverLogs = ["Welcome to Coral Bay Servers...", "Connection Established."];

// Mini-game Variables
var inMiniGame = false;
var targetFish = null;
var captureProgress = 0;
var garyX = 100;
var garyDir = 2;
var reelX = 100;
var osc; 

// Cinematic Variables
var inCutscene = false;
var cutsceneTimer = 0;

function setup() {
  createCanvas(850, 500); // Widened for the Server Log
  updateServerLuck();
  
  // Admin UI
  adminInput = createInput('');
  adminInput.position(20, 120);
  adminInput.size(120);
  let adminBtn = createButton('EXE');
  adminBtn.position(150, 120);
  adminBtn.mousePressed(handleAdmin);

  for (var i = 0; i < 12; i++) {
    fishes.push(new Fish());
  }
  osc = new p5.Oscillator('triangle');
  osc.amp(0);
  osc.start();
}

function addLog(msg) {
  serverLogs.push(msg);
  if (serverLogs.length > 8) serverLogs.shift();
}

function handleAdmin() {
  if (!isOnline) return;
  let val = adminInput.value().toLowerCase();
  let parts = val.split(' ');
  
  if (parts[0] === 'luck') {
    serverLuck = parseFloat(parts[1]) || 1.0;
    addLog("ADMIN: Set Luck to " + serverLuck + "x");
  } else if (parts[0] === 'gold') {
    let amt = parseInt(parts[1]) || 0;
    gold += amt;
    addLog("ADMIN: Granted " + amt + " gold");
  } else if (parts[0] === 'spawn' && parts[1] === 'mythic') {
    forceMythic = true;
    addLog("ADMIN: Forced Mythic spawn");
  }
  adminInput.value('');
}

function updateServerLuck() {
  serverLuck = random(1.0, 5.0).toFixed(1);
  luckTimer = 300 * 60; 
}

class Fish {
  constructor() { this.reset(); }
  reset() {
    this.x = random(-800, -100);
    this.y = random(220, height - 50);  
    this.xSpeed = random(1, 3);
    this.ySpeed = random(-0.5, 0.5);
    
    let r = random(1000000); 
    if (forceMythic) {
        let coin = random(1);
        this.rarity = coin > 0.5 ? "QUANTUM SINGULARITY" : "ORIGIN SOUL";
        this.col = coin > 0.5 ? color(0, 255, 255) : color(255, 255, 255);
        this.val = 1000000;
        this.difficulty = 8.0;
        forceMythic = false;
    }
    else if (r < 10 * serverLuck) { 
        this.rarity = "SECRET"; this.col = color(255, 0, 255); 
        this.val = 25000; this.difficulty = 5.5; 
    }
    else { 
        this.rarity = "COMMON"; this.col = color(255); 
        this.val = 10; this.difficulty = 1.5; 
    }
    this.pileX = -400; this.pileY = -400;
  }
  move() {
    if (inMiniGame || inCutscene || !isOnline) return; 
    this.x += this.xSpeed;
    this.y += this.ySpeed;
    if (this.y < 210 || this.y > height - 20) this.ySpeed *= -1;
    if (this.x > 600) this.reset(); // Stay within water area
  }
  display() {
    tint(this.col);
    image(fishImg, this.x, this.y, 110, 46);
    image(fishImg, this.pileX, this.pileY, 60, 25);
    noTint();
  }
}

function draw() {
  if (inCutscene) { runCutscene(); return; }

  background(40); // Darker aesthetic
  
  // Water Area
  noStroke(); fill(0, 100, 200); rect(0, 200, 650, 300);
  
  // Internet Logic
  if (frameCount % 120 == 0) {
    isOnline = random(100) > 2; // 2% chance of "disconnect"
    ping = floor(random(20, 65));
  }

  // HUD
  drawHUD();

  if (!isOnline) {
    fill(255, 0, 0, 150); rect(0, 200, 650, 300);
    fill(255); textAlign(CENTER); text("CONNECTION LOST - RECONNECTING...", 325, 350);
    textAlign(LEFT);
  } else if (!inMiniGame) {
    displayMainGame();
  } else {
    displayMiniGame();
  }
}

function drawHUD() {
  fill(30); rect(0, 0, width, 200);
  
  // Status
  fill(isOnline ? color(0, 255, 0) : color(255, 0, 0));
  ellipse(30, 30, 10, 10);
  fill(255); textSize(14);
  text(isOnline ? "ONLINE ("+ping+"ms)" : "OFFLINE", 50, 35);
  
  // Stats
  textSize(18); text("üí∞ " + gold + "g", 20, 70);
  text("üçÄ Luck: " + serverLuck + "x", 20, 100);
  
  // Server Logs
  fill(20); rect(400, 10, 430, 180, 5);
  fill(0, 255, 0); textSize(12); textStyle(ITALIC);
  for(let i=0; i < serverLogs.length; i++) {
    text("> " + serverLogs[i], 415, 35 + (i * 20));
  }
  textStyle(NORMAL);
}

function displayMainGame() {
  noFill(); stroke(255, 255, 0); strokeWeight(2);
  line(mouseX, 0, mouseX, mouseY + 125);
  
  for (let f of fishes) {
    f.move();
    f.display();
    if (isOnline && mouseX > f.x && mouseX < f.x + 110 && mouseY + 125 > f.y && mouseY + 125 < f.y + 46) {
      inMiniGame = true; targetFish = f; captureProgress = 0; garyX = 200; reelX = 200;
    }
  }
}

function displayMiniGame() {
  fill(0, 150); rect(0, 200, 650, 300);
  fill(50); stroke(255); rect(175, 300, 300, 80);
  
  garyX += garyDir * targetFish.difficulty;
  if (garyX > 440 || garyX < 180) garyDir *= -1;
  if (keyIsDown(LEFT_ARROW)) reelX -= 5;
  if (keyIsDown(RIGHT_ARROW)) reelX += 5;
  reelX = constrain(reelX, 175, 395);
  
  let onTarget = abs((reelX + 40) - (garyX + 15)) < 40;
  captureProgress += onTarget ? 0.7 : -0.4;
  captureProgress = constrain(captureProgress, 0, 100);
  
  fill(0, 255, 0, 100); rect(reelX, 305, 80, 70);
  fill(targetFish.col); rect(garyX, 330, 30, 20);
  
  fill(255); rect(175, 400, 300, 10);
  fill(0, 255, 0); rect(175, 400, map(captureProgress, 0, 100, 0, 300), 10);
  
  if (captureProgress >= 100) {
    if (targetFish.val > 100) { inCutscene = true; cutsceneTimer = 0; inMiniGame = false; }
    else finishCatch();
  }
}

function runCutscene() {
  background(0); cutsceneTimer++;
  fill(targetFish.col); textAlign(CENTER); textSize(40);
  text("MYTHIC CATCH!", width/2, height/2);
  if (cutsceneTimer > 150) { inCutscene = false; finishCatch(); }
}

function finishCatch() {
  addLog("CATCH: " + targetFish.rarity + " (" + targetFish.val + "g)");
  inMiniGame = false; catchCount++; gold += targetFish.val;
  targetFish.x = -500;
  setTimeout(() => { targetFish.reset(); }, 2000);
}

function preload() {
  fishImg = loadImage('https://upload.wikimedia.org/wikipedia/commons/7/73/Flat_fish_icon.png');
}
